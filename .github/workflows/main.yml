# Workflow to generate a TWRP device tree using twrpdtgen and upload the result.
name: Device Tree Generation (Lenovo YT-X705X)

on:
  # Trigger the workflow on every push to the main branch
  push:
    branches: [ main ]
  # Allow manual execution via the GitHub Actions UI
  workflow_dispatch:

jobs:
  generate_and_upload:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        # Action to pull down the repository code, including the boot.img
        uses: actions/checkout@v4

      - name: Set up Python
        # twrpdtgen is a Python package, so we set up Python 3.x
        uses: actions/setup-python@v5
        with:
          python-version: '3.x' 

      - name: Install twrpdtgen
        # Install the device tree generator tool globally
        run: pip install twrpdtgen

      - name: Generate Device Tree from boot.img (Fixed Command)
        id: generate
        # We explicitly set the vendor and codename to avoid the "AssertionError: Property ro.product.system.device..." error.
        run: |
          echo "Starting device tree generation for YT-X705X (using explicit vendor/codename)..."
          
          # Use explicit flags to ensure twrpdtgen creates the correct directory structure 
          python3 -m twrpdtgen --vendor lenovo --codename YT-X705X ./boot.img
          
          # The script saves the output to the known location based on vendor/codename
          DT_OUTPUT_PATH="device/lenovo/YT-X705X"
          
          # Check if the directory was created successfully
          if [ -d "$DT_OUTPUT_PATH" ]; then
            echo "Successfully generated device tree directory at: $DT_OUTPUT_PATH"
            # Set the path as an output variable for the upload step
            echo "device_tree_path=$DT_OUTPUT_PATH" >> $GITHUB_OUTPUT
          else
            echo "Critical Error: Could not locate the generated device tree directory at $DT_OUTPUT_PATH."
            exit 1
          fi

      - name: Verify Generated Files
        # List the contents of the generated folder for verification and debugging
        run: |
          echo "--- Contents of generated device tree directory ---"
          ls -R ${{ steps.generate.outputs.device_tree_path }}

      - name: Upload Generated Device Tree Artifact
        uses: actions/upload-artifact@v4
        with:
          # Naming the artifact clearly for easy download
          name: lenovo-YT-X705X-device-tree
          # Upload the entire directory created by twrpdtgen
          path: ${{ steps.generate.outputs.device_tree_path }}
          retention-days: 7
          compression-level: 9

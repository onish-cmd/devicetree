# Workflow to generate a TWRP device tree using a manual modification workaround.
name: Device Tree Generation (Lenovo YT-X705X) - AIK Final Fix

on:
  # Trigger the workflow on every push to the main branch
  push:
    branches: [ main ]
  # Allow manual execution via the GitHub Actions UI
  workflow_dispatch:

jobs:
  generate_and_upload:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Your Repository (Step 1)
        # Check out the main repo to get your boot.img
        uses: actions/checkout@v4
        with:
          path: main_repo # Checkout to a specific path

      - name: Checkout Android Image Kitchen (AIK)
        # Use actions/checkout again, which securely handles cloning public repos.
        uses: actions/checkout@v4
        with:
          repository: carliv/android-image-kitchen # The AIK repository
          path: AIK # Clone it into a folder named 'AIK'

      - name: Set up Python and Dependencies
        uses: actions/setup-python@v5
        with:
          python-version: '3.x' 
      
      - name: Install twrpdtgen and AIK dependencies
        run: |
          # Install twrpdtgen
          pip install twrpdtgen
          # Install utilities needed for AIK (cpio)
          sudo apt-get update && sudo apt-get install -y git build-essential cpio

      - name: Manual Image Fix and Device Tree Generation
        id: generate
        run: |
          echo "--- Starting Manual Image Fix and Generation ---"
          
          AIK_DIR="AIK"
          BOOT_IMG_PATH="main_repo/boot.img"
          
          # Check if AIK was successfully cloned
          if [ ! -d "$AIK_DIR" ]; then
            echo "Critical Error: AIK tools directory not found at $AIK_DIR."
            exit 1
          fi
          
          # 1. Unpack the original boot.img
          echo "1. Unpacking original boot.img..."
          # Move boot.img into the AIK folder for processing
          mv $BOOT_IMG_PATH $AIK_DIR/
          cd $AIK_DIR
          ./unpackimg.sh boot.img

          # 2. Inject the missing device property into default.prop
          echo "2. Injecting missing codename property into extracted image..."
          # The missing property is added to ensure twrpdtgen finds the codename later
          echo "ro.product.system.device=YT-X705X" >> split_img/ramdisk/default.prop
          
          # 3. Repack the modified image
          MODIFIED_IMAGE="../boot_modified.img" # Save modified image outside AIK dir
          echo "3. Repacking modified image to $MODIFIED_IMAGE..."
          ./repackimg.sh -o $MODIFIED_IMAGE

          # 4. Move back to root directory and run twrpdtgen on the modified image
          cd ..
          echo "4. Running twrpdtgen on the modified image..."
          python3 -m twrpdtgen $MODIFIED_IMAGE
          
          # 5. Locate the output directory
          DT_OUTPUT_PATH=$(find . -type d -name "YT-X705X" -path "./device/*" 2>/dev/null | head -n 1)
          
          if [ -d "$DT_OUTPUT_PATH" ]; then
            echo "Successfully generated device tree directory at: $DT_OUTPUT_PATH"
            echo "device_tree_path=$DT_OUTPUT_PATH" >> $GITHUB_OUTPUT
          else
            echo "Critical Error: Could not locate the generated device tree directory named 'YT-X705X'."
            exit 1
          fi

      - name: Verify Generated Files
        if: success()
        run: |
          echo "--- Contents of generated device tree directory ---"
          ls -R ${{ steps.generate.outputs.device_tree_path }}

      - name: Upload Generated Device Tree Artifact
        uses: actions/upload-artifact@v4
        with:
          name: lenovo-YT-X705X-device-tree
          path: ${{ steps.generate.outputs.device_tree_path }}
          retention-days: 7
          compression-level: 9

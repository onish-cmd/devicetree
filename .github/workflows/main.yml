# Workflow to generate a TWRP device tree using twrpdtgen and upload the result.
name: Device Tree Generation (Lenovo YT-X705X)

on:
  # Trigger the workflow on every push to the main branch
  push:
    branches: [ main ]
  # Allow manual execution via the GitHub Actions UI
  workflow_dispatch:

jobs:
  generate_and_upload:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x' 

      - name: Install and Upgrade twrpdtgen
        # We use --upgrade to ensure the absolute latest version is installed,
        # which should contain patches for device property extraction errors.
        run: pip install twrpdtgen --upgrade

      - name: Generate Device Tree from boot.img (Upgraded Tool)
        id: generate
        # Using the standard command, hoping the upgraded tool can now find the properties.
        # Format: python3 -m twrpdtgen <path to the recovery image>
        run: |
          echo "Starting device tree generation for YT-X705X with upgraded twrpdtgen..."
          
          # Run the generation
          python3 -m twrpdtgen ./boot.img
          
          # twrpdtgen output directory depends on the name it successfully extracts.
          # We'll use a more robust search pattern for the device tree directory 
          # which should be named after the codename it extracts.
          
          # Search for the directory under 'device/' ending with 'YT-X705X'
          DT_OUTPUT_PATH=$(find . -type d -name "YT-X705X" -path "./device/*" 2>/dev/null | head -n 1)
          
          # If the standard location based on the codename is not found, twrpdtgen may have used 
          # a default or alternate location. Let's rely on finding the specific codename folder.
          
          if [ -d "$DT_OUTPUT_PATH" ]; then
            echo "Successfully generated device tree directory at: $DT_OUTPUT_PATH"
            # Set the path as an output variable for the upload step
            echo "device_tree_path=$DT_OUTPUT_PATH" >> $GITHUB_OUTPUT
          else
            echo "Critical Error: Could not locate the generated device tree directory named 'YT-X705X'."
            echo "Please verify the codename extracted by twrpdtgen or its output location."
            exit 1
          fi

      - name: Verify Generated Files
        # List the contents of the generated folder for verification and debugging
        if: success()
        run: |
          echo "--- Contents of generated device tree directory ---"
          ls -R ${{ steps.generate.outputs.device_tree_path }}

      - name: Upload Generated Device Tree Artifact
        uses: actions/upload-artifact@v4
        with:
          name: lenovo-YT-X705X-device-tree
          # Upload the entire directory found in the previous step
          path: ${{ steps.generate.outputs.device_tree_path }}
          retention-days: 7
          compression-level: 9

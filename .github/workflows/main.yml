# Workflow to generate a TWRP device tree using a manual modification workaround.
name: Device Tree Generation (Lenovo YT-X705X) - AIK Fix

on:
  # Trigger the workflow on every push to the main branch
  push:
    branches: [ main ]
  # Allow manual execution via the GitHub Actions UI
  workflow_dispatch:

jobs:
  generate_and_upload:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x' 

      - name: Install twrpdtgen and required dependencies
        # Install twrpdtgen and ensure we have core utilities like 'find' and 'mktemp'
        run: |
          pip install twrpdtgen
          sudo apt-get update && sudo apt-get install -y git build-essential

      - name: Manual Image Fix and Device Tree Generation
        id: generate
        run: |
          echo "--- Starting Manual Image Fix and Generation ---"
          
          # 1. Initialize twrpdtgen to clone the AIK tools (required dependency)
          # We run a dummy call that fails but ensures AIK tools are cloned into the working directory.
          echo "1. Ensuring AIK tools are cloned..."
          python3 -m twrpdtgen dummy_image || true

          # Check if AIK was successfully cloned
          if [ ! -d "working/AIK" ]; then
            echo "Critical Error: AIK tools were not cloned by twrpdtgen. Cannot proceed."
            exit 1
          fi
          
          # 2. Unpack the original boot.img
          echo "2. Unpacking original boot.img..."
          working/AIK/unpackimg.sh ./boot.img

          # 3. Inject the missing device property into default.prop
          # This bypasses the AssertionError from earlier.
          echo "3. Injecting missing codename property into extracted image..."
          echo "ro.product.system.device=YT-X705X" >> split_img/ramdisk/default.prop
          
          # 4. Repack the modified image
          MODIFIED_IMAGE="boot_modified.img"
          echo "4. Repacking modified image to $MODIFIED_IMAGE..."
          working/AIK/repackimg.sh -o $MODIFIED_IMAGE

          # 5. Run twrpdtgen on the modified image
          echo "5. Running twrpdtgen on the modified image..."
          python3 -m twrpdtgen $MODIFIED_IMAGE
          
          # 6. Locate the output directory
          DT_OUTPUT_PATH=$(find . -type d -name "YT-X705X" -path "./device/*" 2>/dev/null | head -n 1)
          
          if [ -d "$DT_OUTPUT_PATH" ]; then
            echo "Successfully generated device tree directory at: $DT_OUTPUT_PATH"
            echo "device_tree_path=$DT_OUTPUT_PATH" >> $GITHUB_OUTPUT
          else
            echo "Critical Error: Could not locate the generated device tree directory named 'YT-X705X'."
            exit 1
          fi

      - name: Verify Generated Files
        # List the contents of the generated folder for verification and debugging
        if: success()
        run: |
          echo "--- Contents of generated device tree directory ---"
          ls -R ${{ steps.generate.outputs.device_tree_path }}

      - name: Upload Generated Device Tree Artifact
        uses: actions/upload-artifact@v4
        with:
          name: lenovo-YT-X705X-device-tree
          # Upload the entire directory found in the previous step
          path: ${{ steps.generate.outputs.device_tree_path }}
          retention-days: 7
          compression-level: 9
